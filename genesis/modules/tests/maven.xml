<project xmlns:m="maven" xmlns:jxr="jxr" xmlns:j="jelly:core" 
   xmlns:ant="jelly:ant" xmlns:u="jelly:util" xmlns:maven="jelly:maven">
   
   <maven:makeAbsolutePath
         var="absolute.xdoclet.dist"
         basedir="${genesis.basedir}"
         path="${genesis.xdoclet.dist}" />
   <maven:makeAbsolutePath
         var="absolute.thinlet.dist"
         basedir="${genesis.basedir}"
         path="${genesis.thinlet.dist}" />
   <maven:makeAbsolutePath
         var="absolute.aspectwerkz.dist"
         basedir="${genesis.basedir}"
         path="${genesis.aspectwerkz.dist}" />
   <maven:makeAbsolutePath
         var="absolute.hibernate.dist"
         basedir="${genesis.basedir}"
         path="${genesis.hibernate.dist}" />
   <maven:makeAbsolutePath
         var="absolute.commons.dist"
         basedir="${genesis.basedir}"
         path="${genesis.commons.dist}" />
   <maven:makeAbsolutePath
         var="absolute.j2ee.dist"
         basedir="${genesis.basedir}"
         path="${genesis.j2ee.dist}" />
   <maven:makeAbsolutePath
         var="absolute.module.aspect"
         basedir="${genesis.basedir}"
         path="${genesis.module.aspect}" />
   <maven:makeAbsolutePath
         var="absolute.module.client"
         basedir="${genesis.basedir}"
         path="${genesis.module.client}" />
   <maven:makeAbsolutePath
         var="absolute.module.shared"
         basedir="${genesis.basedir}"
         path="${genesis.module.shared}" />
   <maven:makeAbsolutePath
         var="absolute.module.server"
         basedir="${genesis.basedir}"
         path="${genesis.module.server}" />
   <maven:makeAbsolutePath
         var="absolute.jar.thinlet"
         basedir="${genesis.basedir}"
         path="${maven.jar.thinlet}" />         
   <maven:makeRelativePath
         var="relative.src.dir"
         basedir="${basedir}"
         path="${maven.src.dir}" />
   <maven:makeRelativePath
         var="relative.build.dest"
         basedir="${basedir}"
         path="${maven.build.dest}" />
   <maven:makeRelativePath
         var="relative.annotation.dest"
         basedir="${basedir}"
         path="${genesis.annotation.dest}" />
         
   <path id="xdoclet.path">
      <fileset dir="${absolute.xdoclet.dist}" includes="*.jar" />
   </path>
   <path id="thinlet.path">
      <fileset dir="${absolute.thinlet.dist}" includes="*.jar" />
   </path>
   <path id="aspectwerkz.path">
      <fileset dir="${absolute.aspectwerkz.dist}" includes="*.jar" />
   </path>
   <path id="hibernate.path">
      <fileset dir="${absolute.hibernate.dist}" includes="*.jar" />
   </path>
   <path id="commons.path">
      <fileset dir="${absolute.commons.dist}" includes="*.jar" />
   </path>
   <path id="j2ee.path">
      <fileset dir="${absolute.j2ee.dist}" includes="*.jar" />
   </path>
   
   <preGoal name="test:compile">
      <mkdir dir="${maven.build.src}"/>
      <taskdef name="hibernatedoclet" 
         classname="xdoclet.modules.hibernate.HibernateDocletTask">
         <classpath refid="xdoclet.path" />
      </taskdef>
      <hibernatedoclet destdir="${maven.build.src}" 
         verbose="true">
         <fileset dir="${maven.src.dir}">
            <include name="**/*.java" />
         </fileset>
         <hibernate version="2.0" xmlencoding="ISO-8859-1" validateXML="false" 
            />
         <jbossservice jndiName="jboss:/hibernate/SessionFactory" 
            serviceName="HibernateFactory,name=HibernateFactory" 
            dialect="${genesis.unit.test.hibernate.dialect}" 
            dataSource="java:/DefaultDS" 
            transactionManagerStrategy="net.sf.hibernate.transaction.JBossTransactionManagerLookup" 
            transactionStrategy="net.sf.hibernate.transaction.JTATransactionFactory" 
            userTransactionName="UserTransaction" useouterjoin="false" 
            showSql="true" />
         <hibernatecfg dialect="${genesis.unit.test.hibernate.dialect}" 
            userName="${genesis.unit.test.jdbc.connection.username}" 
            password="${genesis.unit.test.jdbc.connection.password}" 
            driver="${genesis.unit.test.jdbc.driver.class}" 
            jdbcUrl="${genesis.unit.test.jdbc.connection.url}" 
            transactionManagerStrategy="net.sf.hibernate.transaction.JDBCTransactionFactory" 
            showSql="true" />
      </hibernatedoclet>
   </preGoal>
   
   <postGoal name="test:compile">
      <attainGoal name="genesis:annotation" />
      <attainGoal name="genesis:weaving" />
      <attainGoal name="genesis:test:deploy" />
   </postGoal>
   
   <preGoal name="test:test">
      <j:set var="maven.dependency.classpath" value=""/>
      <j:set var="maven.test.dest" value="${genesis.weaving.dest}"/>
      <path id="misc.path">
         <pathelement 
            path="${genesis.jboss.home}/client/jbossall-client.jar" />
         <pathelement path="${genesis.jdbc.driver}"/>
      </path>
      <maven:addPath
          id="maven.dependency.classpath"
          refid="aspectwerkz.path"/>
      <maven:addPath
          id="maven.dependency.classpath"
          refid="j2ee.path"/>
      <maven:addPath
          id="maven.dependency.classpath"
          refid="commons.path"/>
      <maven:addPath
          id="maven.dependency.classpath"
          refid="hibernate.path"/>
      <maven:addPath
          id="maven.dependency.classpath"
          refid="genesis.weaving.path"/>
      <maven:addPath
          id="maven.dependency.classpath"
          refid="misc.path"/>
   </preGoal>
   
   <goal name="genesis:annotation">
      <ant:mkdir dir="${genesis.annotation.dest}"/>
      <java classname="org.codehaus.aspectwerkz.annotation.AnnotationC" 
         fork="true">
         <arg value="-verbose" />
         <arg value="-src" />
         <arg value="${maven.src.dir}" />
         <arg value="-classes" />
         <arg value="${maven.test.dest}" />
         <arg value="-dest" />
         <arg value="${genesis.annotation.dest}" />
         <arg value="-custom" />
         <arg value="${absolute.module.aspect}/${relative.src.dir}/annotation.properties" />
         <classpath>
            <path refid="aspectwerkz.path" />
         </classpath>
      </java>
   </goal>
   
   <goal name="genesis:weaving">
      <mkdir dir="${genesis.weaving.dest}" />
      <path id="weaving.path">
         <pathelement path="${absolute.module.aspect}/${relative.build.dest}"/>
         <pathelement path="${absolute.module.shared}/${relative.build.dest}"/>
         <pathelement path="${absolute.module.client}/${relative.build.dest}"/>
         <path refid="hibernate.path" />
         <path refid="commons.path" />
         <path refid="thinlet.path" />
      </path>
      <pathconvert pathsep="${path.separator}" property="normalized.path" 
         refid="weaving.path"/>
      <unjar src="${absolute.jar.thinlet}" 
         dest="${genesis.weaving.dest}" overwrite="true" />
      <copy todir="${genesis.weaving.dest}" overwrite="true">
         <fileset dir="${absolute.module.aspect}/${relative.build.dest}"/>
         <fileset dir="${absolute.module.client}/${relative.build.dest}"/>
         <fileset dir="${absolute.module.shared}/${relative.annotation.dest}"/>
         <fileset dir="${genesis.annotation.dest}"/>
         <fileset dir="${maven.build.dir}/test-classes" excludes="**/*.class"/>
         <fileset dir="${maven.src.dir}" excludes="**/*.java"/>
         <fileset dir="${maven.build.src}" excludes="**/*.java"/>
      </copy>
      <java classname="org.codehaus.aspectwerkz.compiler.AspectWerkzC" 
         fork="true">
         <arg value="-cp" />
         <arg value="${normalized.path}" />
         <arg value="-verbose" />
         <arg value="-haltOnError" />
         <arg value="${genesis.weaving.dest}" />
         <jvmarg 
            value="-Daspectwerkz.definition.file=${maven.src.dir}/aspectwerkz.xml" 
            />
         <classpath>
            <path refid="aspectwerkz.path" />
            <path refid="j2ee.path" />
            <path refid="thinlet.path" />
            <path refid="commons.path" />
            <pathelement path="${absolute.module.client}/${relative.build.dest}"/>
            <pathelement path="${absolute.module.shared}/${relative.build.dest}"/>
         </classpath>
      </java>
   </goal>
   
   <goal name="genesis:test:deploy">
      <mkdir dir="${genesis.jboss.app}/deploy/hibernate.sar" />
      <mkdir dir="${genesis.jboss.app}/deploy/genesis.jar" />
      <copy todir="${genesis.jboss.app}/deploy/hibernate.sar">
         <fileset dir="${maven.build.src}">
            <include name="**/*.hbm.xml" />
         </fileset>
         <fileset dir="${maven.build.dir}/test-classes">
            <include name="**/*Bean.class" />
            <include name="hibernate.properties" />
         </fileset>
      </copy>
      <copy todir="${genesis.jboss.app}/deploy/hibernate.sar/META-INF">
         <fileset dir="${maven.build.src}" includes="jboss-service.xml" 
            />
      </copy>
      <copy todir="${genesis.jboss.app}/lib">
         <fileset dir="${absolute.hibernate.dist}">
            <include name="commons-logging*.jar" />
            <include name="log4j*.jar" />
            <include name="dom4j*.jar" />
            <include name="optional*.jar" />
            <include name="commons-collections*.jar" />
            <include name="ehcache*.jar" />
            <include name="cglib*.jar" />
            <include name="odmg*.jar" />
            <include name="hibernate2.jar" />
         </fileset>
         <fileset dir="${absolute.commons.dist}">
            <include name="commons-beanutils*.jar" />
         </fileset>
      </copy>
      <copy todir="${genesis.jboss.app}/deploy/genesis.jar">
         <fileset dir="${absolute.module.server}/${relative.build.dest}" />
         <fileset dir="${absolute.module.shared}/${relative.build.dest}" />
         <fileset dir="${maven.build.dir}/test-classes" includes="**/*.class"/>
      </copy>
   </goal>
   
</project>