<?xml version="1.0" encoding="ISO-8859-1"?>
<project basedir="." default="genesis.app:all.with.webstart" name="genesis based app">

   <target name="init" unless="TSTAMP">
      <tstamp/>
      <!-- load custom properties -->
      <property file="build.properties" />

      <!-- properties -->
      <property name="genesis.home" location="../../genesis" />
      <property name="genesis.dist" location="${genesis.home}/dist" />
      <property name="genesis.version" value="2.2-dev" />
      <property name="xdoclet.dist" location="../../xdoclet/dist" />
      <property name="aspectwerkz.dist" location="${genesis.home}/lib/aspectwerkz" />
      <property name="hibernate.dist" location="${genesis.home}/lib/hibernate" />
      <property name="commons.dist" location="${genesis.home}/lib/commons" />
      <property name="thinlet.dist" location="${genesis.home}/lib/thinlet" />
      <property name="j2ee.dist" location="${genesis.home}/lib/j2ee" />
      <property name="annotation.properties" location="${genesis.dist}/annotation.properties" />
      <property name="module.shared" location="./modules/shared" />
      <property name="module.client" location="./modules/client" />
      <property name="build.dir" value="target" />
      <property name="lib.dir" value="lib" />
      <property name="dist.dir" value="dist" />
      <property name="build.dest" value="${build.dir}/classes" />
      <property name="build.src" value="${build.dir}/src" />
      <property name="annotation.dest" value="${build.dir}/annotation" />
      <property name="weaving.dest" value="${build.dir}/weaving" />
      <property name="src.dir" value="src" />
      <property name="webstart.dir" location="webstart" />
      <property name="generate.client.validation" value="true" />
      <property name="verbose" value="true" />
      <property name="debug.port" value="10000" />

      <property name="genesisBasedApplication.serverName" value="${genesisBasedApplication.name}" />

      <!-- jboss and server properties -->
      <property name="jboss.app" location="${jboss.home}/server/${genesisBasedApplication.serverName}" />
      <property name="jboss.provider.url" value="jnp://localhost" />
      <property name="jboss.factory.initial" value="org.jnp.interfaces.NamingContextFactory" />
      <property name="jboss.datasource.jndi.name" value="java:/DefaultDS" />
      <property name="jboss.datasource.config.xml" location="${jboss.home}/server/default/deploy/hsqldb-ds.xml" />
      <property name="webstart.server" value="localhost" />
      <property name="webstart.port" value="8080" />

      <!-- hibernate properties -->
      <property name="hibernate.dialect" value="net.sf.hibernate.dialect.HSQLDialect"/>
      <property name="hibernate.version" value="2.1.6" />
      <property name="hibernate.show.sql" value="true" />
      <property name="hibernate.session.factory.jndi.name" value="jboss:/hibernate/SessionFactory" />
      <property name="hibernate.jboss.service.name" value="HibernateFactory,name=HibernateFactory" />

      <path id="j2ee.path">
         <fileset dir="${j2ee.dist}" includes="*.jar" />
      </path>

      <path id="xdoclet.path">
         <fileset dir="${xdoclet.dist}" includes="*.jar" />
      </path>

      <path id="aspectwerkz.path">
         <fileset dir="${aspectwerkz.dist}">
            <include name="aspectwerkz-*.jar" />
            <include name="ant*.jar" />
            <exclude name="asm*.jar" />
            <include name="concurrent*.jar" />
            <include name="dom4j*.jar" />
            <include name="javassist*.jar" />
            <include name="jrexx*.jar" />
            <include name="junit*.jar" />
            <include name="managementapi*.jar" />
            <include name="piccolo*.jar" />
            <include name="qdox*.jar" />
            <include name="trove*.jar" />
         </fileset>
      </path>

      <!-- shared.dependency.classpath: All jars needed to compile shared module -->
      <path id="shared.dependency.classpath">
         <!-- If you need additional jars to compile shared module, add them here as follows:
         <fileset dir="additional_jars_directory">
            <include name="one.jar" />
            <include name="two.jar" />
            ...
            <include name="another.jar" />
         </fileset>
         <fileset dir="another_jars_directory">
            <include name="some.jar" />
            <include name="foo.jar" />
            ...
            <include name="killer.jar" />
         </fileset>
         -->
         <fileset dir="${genesis.dist}"
                  includes="genesis-shared-${genesis.version}.jar" />
         <fileset dir="${hibernate.dist}" includes="hibernate*.jar" />
         <fileset dir="${commons.dist}">
            <include name="commons-beanutils*.jar" />
            <include name="commons-logging*.jar" />
            <include name="reusable-components*.jar" />
         </fileset>
      </path>

      <!-- client.dependency.classpath: All jars needed to compile client module -->
      <path id="client.dependency.classpath">
         <!-- If you need additional jars to compile client module, add them here as follows:
         <fileset dir="additional_jars_directory">
            <include name="one.jar" />
            <include name="two.jar" />
            ...
            <include name="another.jar" />
         </fileset>
         <fileset dir="another_jars_directory">
            <include name="some.jar" />
            <include name="foo.jar" />
            ...
            <include name="bar.jar" />
         </fileset>
         -->
         <path location="${module.shared}/${build.dest}" />
         <path refid="aspectwerkz.path" />
         <fileset dir="${genesis.dist}">
            <include name="genesis-shared-${genesis.version}.jar" />
            <include name="genesis-client-${genesis.version}.jar" />
         </fileset>
         <fileset dir="${commons.dist}">
            <include name="commons-beanutils*.jar" />
            <include name="commons-digester*.jar" />
            <include name="commons-jxpath*.jar" />
            <include name="commons-logging*.jar" />
            <include name="commons-validator*.jar" />
            <include name="jakarta-oro-*.jar" />
            <include name="reusable-components*.jar" />
         </fileset>
         <fileset dir="${thinlet.dist}" includes="thinlet*.jar" />
         <!-- You can comment this if you are not using Hibernate -->
         <fileset dir="${hibernate.dist}" includes="hibernate*.jar" />
      </path>

      <!-- run.classpath: All jars needed to run your desktop application -->
      <path id="run.classpath">
         <!-- If you need additional jars to run your application, add them here as follows:
         <fileset dir="additional_jars_directory">
            <include name="one.jar" />
            <include name="two.jar" />
            ...
            <include name="another.jar" />
         </fileset>
         <fileset dir="another_jars_directory">
            <include name="some.jar" />
            <include name="foo.jar" />
            ...
            <include name="bar.jar" />
         </fileset>
         -->
         <path location="${weaving.dest}" />
         <fileset dir="${genesis.dist}">
            <include name="genesis-aspect-annotated-*.jar" />
            <include name="genesis-client-*.jar" />
         </fileset>
         <fileset dir="${aspectwerkz.dist}">
            <include name="aspectwerkz-*.jar" />
            <include name="dom4j-*.jar" />
            <include name="jrexx-*.jar" />
            <include name="trove-*.jar" />
         </fileset>
         <fileset dir="${hibernate.dist}">
            <include name="hibernate2.jar" />
            <include name="commons-collections-*.jar" />
         </fileset>
         <fileset dir="${commons.dist}">
            <include name="commons-beanutils-*.jar" />
            <include name="commons-digester-*.jar" />
            <include name="commons-jxpath-*.jar" />
            <include name="commons-logging-*.jar" />
            <include name="commons-validator-*.jar" />
            <include name="jakarta-oro-*.jar" />
            <include name="reusable-components-*.jar" />
         </fileset>
         <fileset dir="${jboss.home}/client">
            <include name="jboss-client.jar" />
            <include name="jboss-common-client.jar" />
            <include name="jboss-j2ee.jar" />
            <include name="jboss-transaction-client.jar" />
            <include name="jbosssx-client.jar" />
            <include name="jnp-client.jar" />
         </fileset>
      </path>

      <taskdef name="annotationc" classname="org.codehaus.aspectwerkz.annotation.AnnotationCTask" classpathref="aspectwerkz.path" />
      <taskdef name="awc" classname="org.codehaus.aspectwerkz.compiler.AspectWerkzCTask" classpathref="aspectwerkz.path" />
      <taskdef name="hibernatedoclet" classname="xdoclet.modules.hibernate.HibernateDocletTask" classpathref="xdoclet.path" />
      <taskdef name="genesisdoclet" classname="xdoclet.modules.genesis.GenesisDocletTask" classpathref="xdoclet.path" />

      <condition property="generate.validation">
         <istrue value="${generate.client.validation}" />
      </condition>
   </target>

   <target name="shared:clean" depends="init">
      <delete dir="${module.shared}/${build.dir}" />
   </target>

   <target name="shared:client.compile" depends="init">
      <mkdir dir="${module.shared}/${build.dest}" />
      <javac destdir="${module.shared}/${build.dest}"
             debug="true"
             source="1.4"
             classpathref="shared.dependency.classpath">
         <src path="${module.shared}/${src.dir}" />
      </javac>
      <copy todir="${module.shared}/${build.dest}" overwrite="false">
         <fileset dir="${module.shared}/${src.dir}" excludes="**/*.java" />
      </copy>
      <antcall target="shared:annotation" />
   </target>

   <target name="shared:compile" depends="init,shared:hibernatedoclet,shared:client.compile" />

   <target name="shared:annotation" depends="init">
      <annotationc verbose="${verbose}"
            srcdir="${module.shared}/${src.dir}"
            destdir="${module.shared}/${annotation.dest}"
            classpath="${module.shared}/${build.dest}"
            properties="${annotation.properties}" />
      <copy todir="${module.shared}/${annotation.dest}" overwrite="false">
         <fileset dir="${module.shared}/${build.dest}" />
      </copy>
   </target>

   <target name="shared:hibernatedoclet" depends="init">
      <basename property="jboss.ds.name" file="${jboss.datasource.jndi.name}"/>
      <mkdir dir="${module.shared}/${build.src}" />
      <hibernatedoclet destdir="${module.shared}/${build.src}" verbose="${verbose}">
         <fileset dir="${module.shared}/${src.dir}">
            <include name="**/*.java" />
         </fileset>
         <hibernate version="2.0"
                    xmlencoding="ISO-8859-1"
                    validateXML="false" />
         <jbossservice jndiName="${hibernate.session.factory.jndi.name}"
                       serviceName="${hibernate.jboss.service.name}"
                       dialect="${hibernate.dialect}"
                       dataSource="${jboss.datasource.jndi.name}"
                       transactionManagerStrategy="net.sf.hibernate.transaction.JBossTransactionManagerLookup"
                       transactionStrategy="net.sf.hibernate.transaction.JTATransactionFactory"
                       userTransactionName="UserTransaction"
                       showSql="${hibernate.show.sql}"
                       depends="jboss.jca:service=LocalTxCM,name=${jboss.ds.name}"
                       version="${hibernate.version}" />
        <!-- Uncomment the following section if you are going to run in local mode
        <hibernatecfg dialect="${hibernate.dialect}"
                       userName="a_valid_user_name"
                       password="password_for_user"
                       driver="your_database_driver_class_name"
                       jdbcUrl="_a_jdbc_connection_url"
                       transactionManagerStrategy="net.sf.hibernate.transaction.JDBCTransactionFactory"
                       showSql="${hibernate.show.sql}"
        /-->
      </hibernatedoclet>
      <copy todir="${module.shared}/${build.dest}">
         <fileset dir="${module.shared}/${build.src}" />
      </copy>
   </target>

   <target name="client:clean" depends="init">
      <delete dir="${module.client}/${build.dir}" />
   </target>

   <target name="client:compile" depends="init">
      <mkdir dir="${module.client}/${build.dest}" />
      <javac destdir="${module.client}/${build.dest}"
             debug="true"
             source="1.4"
             classpathref="client.dependency.classpath">
         <src path="${module.client}/${src.dir}" />
      </javac>
      <copy todir="${module.client}/${build.dest}" overwrite="false">
         <fileset dir="${module.client}/${src.dir}" excludes="**/*.java" />
      </copy>
      <antcall target="client:validation" />
      <antcall target="client:annotation" />
   </target>

   <target name="client:annotation" depends="init">
      <annotationc verbose="${verbose}"
            srcdir="${module.client}/${src.dir}"
            destdir="${module.client}/${annotation.dest}"
            classpath="${module.client}/${build.dest}"
            properties="${annotation.properties}" />
      <copy todir="${module.client}/${annotation.dest}" overwrite="false">
         <fileset dir="${module.client}/${build.dest}" />
      </copy>
   </target>

   <!-- If you want to turn off the validation generation task,
      set the 'generate.client.validation' property to false -->
   <target name="client:validation" if="generate.validation" depends="init">
      <genesisdoclet destdir="${module.client}/${build.dest}" verbose="${verbose}">
         <fileset dir="${module.client}/${src.dir}" includes="**/*.java" />
         <genesisvalidationxml xmlencoding="ISO-8859-1" />
      </genesisdoclet>
   </target>

   <target name="genesis.app:weaving" depends="init">
      <mkdir dir="${weaving.dest}" />
      <copy todir="${weaving.dest}" overwrite="true">
         <fileset dir="${module.client}/${annotation.dest}" />
         <fileset dir="${module.shared}/${annotation.dest}" />
      </copy>
      <unjar dest="${weaving.dest}" overwrite="true">
          <fileset dir="${thinlet.dist}" includes="thinlet*.jar" />
          <fileset dir="${genesis.dist}"
                   includes="genesis-shared-annotated-${genesis.version}.jar" />
      </unjar>
      <awc verbose="${verbose}">
         <classpath>
            <path path="${genesis.dist}/genesis-aspect-annotated-${genesis.version}.jar" />
            <path refid="client.dependency.classpath" />
            <path refid="shared.dependency.classpath" />
            <path refid="j2ee.path" />
         </classpath>
         <targetpath location="${weaving.dest}"/>
      </awc>
   </target>

   <target name="genesis.app:clean" depends="init,shared:clean,client:clean">
      <delete dir="${build.dir}" />
      <delete dir="${dist.dir}" />
   </target>

   <target name="genesis.app:compile"
           depends="init,genesis.app:clean,shared:compile,client:compile,genesis.app:weaving">
   </target>

   <target name="genesis.app:client.compile"
           depends="init,genesis.app:clean,shared:client.compile,client:compile,genesis.app:weaving">
   </target>

   <target name="genesis.app:jar" depends="init">
      <mkdir dir="${build.dir}" />
      <jar destfile="${build.dir}/${genesisBasedApplication.name}-weaved.jar">
         <fileset dir="${weaving.dest}" />
      </jar>
      <jar destfile="${build.dir}/${genesisBasedApplication.name}-shared.jar">
         <fileset dir="${module.shared}/${build.dest}"
                  excludes="jboss-service.xml" />
      </jar>
   </target>

   <target name="genesis.app:sar" depends="init">
      <mkdir dir="${dist.dir}"/>
      <zip destfile="${dist.dir}/${genesisBasedApplication.name}.sar">
         <!-- If you need additional jars at server side to run your application, add them here as follows:
         <fileset dir="additional_jars_directory">
            <include name="one.jar" />
            <include name="two.jar" />
            ...
            <include name="another.jar" />
         </fileset>
         <fileset dir="another_jars_directory">
            <include name="some.jar" />
            <include name="foo.jar" />
            ...
            <include name="bar.jar" />
         </fileset>
         -->
         <fileset dir="${module.shared}/${build.src}">
            <include name="**/*.hbm.xml" />
         </fileset>
         <fileset dir="${module.shared}/${build.dest}">
            <include name="hibernate.properties" />
         </fileset>
         <zipfileset dir="${module.shared}/${build.src}"
               includes="jboss-service.xml" prefix="META-INF" />
         <fileset dir="${hibernate.dist}">
            <include name="commons-logging*.jar" />
            <include name="log4j*.jar" />
            <include name="dom4j*.jar" />
            <include name="optional*.jar" />
            <include name="commons-collections*.jar" />
            <include name="ehcache*.jar" />
            <include name="cglib*.jar" />
            <include name="odmg*.jar" />
            <include name="hibernate*.jar" />
         </fileset>
         <fileset dir="${commons.dist}">
            <include name="commons-beanutils*.jar" />
            <include name="reusable-components*.jar" />
         </fileset>
         <fileset dir="${genesis.dist}">
            <include name="genesis-shared-${genesis.version}.jar" />
         </fileset>
         <fileset dir="${build.dir}">
            <include name="${genesisBasedApplication.name}-shared.jar" />
         </fileset>
      </zip>
   </target>

   <target name="genesis.app:war" depends="init">
      <mkdir dir="${dist.dir}/${genesisBasedApplication.name}.war/application"/>
      <copy todir="${dist.dir}/${genesisBasedApplication.name}.war/application">
         <!-- WEBSTART jars -->
         <!-- If you need additional jars at server side to run your webstart application, add them here as follows:
         <fileset dir="additional_jars_directory">
            <include name="one.jar" />
            <include name="two.jar" />
            ...
            <include name="another.jar" />
         </fileset>
         <fileset dir="another_jars_directory">
            <include name="some.jar" />
            <include name="foo.jar" />
            ...
            <include name="bar.jar" />
         </fileset>

         DON'T FORGET TO ADD THEM IN webstart/application/webstart.jnlp FILE
         -->
         <fileset dir="${build.dir}">
            <include name="${genesisBasedApplication.name}-weaved.jar" />
         </fileset>
         <fileset dir="${hibernate.dist}">
            <include name="commons-collection*.jar" />
            <include name="hibernate*.jar" />
         </fileset>
         <fileset dir="${genesis.dist}">
            <include name="genesis-client-${genesis.version}.jar"/>
            <include name="genesis-aspect-annotated-${genesis.version}.jar" />
         </fileset>
         <fileset dir="${commons.dist}">
            <include name="commons-beanutils*.jar"/>
            <include name="commons-jxpath*.jar"/>
            <include name="commons-logging*.jar"/>
            <include name="commons-digester*.jar"/>
            <include name="commons-validator*.jar"/>
            <include name="jakarta-oro-*.jar" />
            <include name="reusable-components*.jar"/>
         </fileset>
         <fileset dir="${aspectwerkz.dist}">
            <include name="aspectwerkz-*.jar" />
            <include name="dom4j*.jar" />
            <include name="jrexx-*.jar" />
            <include name="trove*.jar" />
         </fileset>
         <fileset dir="${jboss.home}/client">
            <include name="jboss-client.jar" />
            <include name="jboss-common-client.jar" />
            <include name="jboss-j2ee.jar" />
            <include name="jboss-transaction-client.jar" />
            <include name="jbosssx-client.jar" />
            <include name="jnp-client.jar" />
         </fileset>
      </copy>
      <copy todir="${dist.dir}/${genesisBasedApplication.name}.war">
         <filterset>
            <filter token="genesis.version" value="${genesis.version}"/>
            <filter token="jboss.provider.url" value="${jboss.provider.url}"/>
            <filter token="jboss.factory.initial" value="${jboss.factory.initial}" />
            <filter token="jboss.provider.port" value="${jboss.provider.port}"/>
            <filter token="webstart.server" value="${webstart.server}"/>
            <filter token="webstart.port" value="${webstart.port}"/>
            <filter token="webstart.context" value="${genesisBasedApplication.name}"/>
            <filter token="app.main" value="${genesisBasedApplication.mainClass}"/>
            <filter token="pretty.name" value="${genesisBasedApplication.prettyName}"/>
         </filterset>
         <fileset dir="${webstart.dir}">
            <include name="**/*.jnlp"/>
            <include name="**/*.html"/>
         </fileset>
      </copy>
      <copy todir="${dist.dir}/${genesisBasedApplication.name}.war">
         <fileset dir="${webstart.dir}">
            <exclude name="**/*.jnlp"/>
         </fileset>
      </copy>
      <signjar alias="genesis"
            keystore="${webstart.dir}/application/genesis.keystore"
            storepass="summa@brasil" keypass="g3n3sis">
         <fileset dir="${dist.dir}/${genesisBasedApplication.name}.war/application">
            <include name="*.jar"/>
         </fileset>
      </signjar>
   </target>

   <target name="genesis.app:create.jboss.app.dir" unless="app.dir.exists" depends="init">
      <condition property="jboss.home.not.found">
         <available type="dir" file="${jboss.home}" />
      </condition>
      <fail unless="jboss.home.not.found">
         JBoss Home not found. Set 'jboss.home' properly in buid.properties file. See build.properties.sample for details.
      </fail>
      <mkdir dir="${jboss.app}" />
      <copy todir="${jboss.app}">
         <fileset dir="${jboss.home}/server/default">
            <include name="deploy/jboss-jca.sar" />
            <include name="deploy/jboss-local-jdbc.rar" />
            <include name="deploy/transaction-service.xml" />
            <include name="deploy/jbossweb-tomcat*.sar/**" />
            <include name="conf/**" />
            <include name="lib/**" />
            <exclude name="lib/hibernate2.jar" />
         </fileset>
      </copy>
   </target>

   <target name="genesis.app:deploy" depends="init,genesis.app:sar">
      <available type="dir" file="${jboss.app}" property="app.dir.exists" />
      <antcall target="genesis.app:create.jboss.app.dir"/>
      <delete>
         <fileset dir="${jboss.app}/deploy">
            <include name="*-ds.xml" />
            <!-- Warning... If you have others datasource configuration files
                  at ${jboss.app}/deploy directory, and they cannot be deleted,
                  add them here as follows:

            <exclude name="my-ds.xml" />
            -->
         </fileset>
      </delete>
      <copy todir="${jboss.app}/deploy">
         <fileset file="${jboss.datasource.config.xml}" />
         <fileset dir="${genesis.dist}">
            <include name="genesis-server-${genesis.version}.jar"/>
         </fileset>
         <fileset dir="${dist.dir}">
            <include name="${genesisBasedApplication.name}.sar"/>
         </fileset>
      </copy>
   </target>

   <target name="genesis.app:deploy.webstart" depends="init,genesis.app:war">
      <mkdir dir="${jboss.app}/deploy/${genesisBasedApplication.name}.war"/>
      <copy todir="${jboss.app}/deploy/${genesisBasedApplication.name}.war">
        <fileset dir="${dist.dir}/${genesisBasedApplication.name}.war">
           <include name="**/*" />
         </fileset>
       </copy>
   </target>

   <target name="genesis.app:dist" depends="init,genesis.app:compile,genesis.app:jar,genesis.app:sar,genesis.app:war" />

   <target name="genesis.app:all"
           depends="init,genesis.app:compile,genesis.app:jar,genesis.app:deploy" />

   <target name="genesis.app:all.with.webstart"
          depends="init,genesis.app:all,genesis.app:deploy.webstart" />

   <target name="genesis.app:run" depends="init">
      <java classname="${genesisBasedApplication.mainClass}" fork="true" failonerror="true" classpathref="run.classpath">
         <sysproperty key="java.naming.factory.initial"
                      value="${jboss.factory.initial}" />
         <sysproperty key="java.naming.provider.url"
                      value="${jboss.provider.url}" />
      </java>
   </target>

   <target name="genesis.app:run-with-debug" depends="init">
      <java classname="${genesisBasedApplication.mainClass}" fork="true" failonerror="true" classpathref="run.classpath">
         <sysproperty key="java.naming.factory.initial"
                      value="${jboss.factory.initial}" />
         <sysproperty key="java.naming.provider.url"
                      value="${jboss.provider.url}" />
         <sysproperty key="aspectwerkz.transform.verbose"
                      value="${verbose}" />
         <jvmarg value="-Xdebug"/>
         <jvmarg value="-Xrunjdwp:transport=dt_socket,address=${debug.port},server=y,suspend=n"/>
      </java>
   </target>

   <target name="genesis.app:run-with-logging-on" depends="init">
      <java classname="${genesisBasedApplication.mainClass}" fork="true" failonerror="true" classpathref="run.classpath">
         <sysproperty key="java.naming.factory.initial"
                      value="${jboss.factory.initial}" />
         <sysproperty key="java.naming.provider.url"
                      value="${jboss.provider.url}" />
         <sysproperty key="aspectwerkz.transform.verbose"
                      value="${verbose}" />
         <sysproperty key="java.util.logging.config.file"
                      value="${module.client}/conf/logging.properties" />
      </java>
   </target>

</project>