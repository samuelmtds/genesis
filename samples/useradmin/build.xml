<?xml version="1.0" encoding="ISO-8859-1"?>
<project basedir="." default="useradmin:all" name="genesis useradmin sample">
   <property file="build.properties" />

   <property name="genesis.home" location="../../genesis" />
   <property name="genesis.dist" location="${genesis.home}/dist" />
   <property name="genesis.version" value="0.2-dev" />
   <property name="xdoclet.dist" location="../../xdoclet/dist" />
   <property name="hibernate.dist" location="${genesis.home}/lib/hibernate" />
   <property name="commons.dist" location="${genesis.home}/lib/commons" />
   <property name="thinlet.dist" location="${genesis.home}/lib/thinlet" />
   <property name="j2ee.dist" location="${genesis.home}/lib/j2ee" />
   <property name="annotation.properties"
             location="${genesis.dist}/annotation.properties" />

   <property name="module.shared" location="./modules/shared" />
   <property name="module.client" location="./modules/client" />
   <property name="build.dir" value="target" />
   <property name="lib.dir" value="lib" />
   <property name="build.dest" value="${build.dir}/classes" />
   <property name="build.src" value="${build.dir}/src" />
   <property name="annotation.dest" value="${build.dir}/annotation" />
   <property name="weaving.dest" value="${build.dir}/weaving" />
   <property name="src.dir" value="src" />

   <property name="jboss.app" value="${jboss.home}/server/useradmin" />
   <property name="jboss.provider.url" value="localhost" />

   <path id="j2ee.path">
      <fileset dir="${j2ee.dist}" includes="*.jar" />
   </path>

   <path id="xdoclet.path">
      <path refid="j2ee.path" />
      <fileset dir="${xdoclet.dist}" includes="*.jar" />
   </path>

   <path id="aspectwerkz.path">
      <fileset dir="${genesis.home}/lib/aspectwerkz">
         <include name="aspectwerkz*.jar" />
         <include name="ant*.jar" />
         <exclude name="asm*.jar" />
         <include name="concurrent*.jar" />
         <include name="dom4j*.jar" />
         <include name="javassist*.jar" />
         <include name="jrexx*.jar" />
         <include name="junit*.jar" />
         <include name="managementapi*.jar" />
         <include name="piccolo*.jar" />
         <include name="qdox*.jar" />
         <include name="trove*.jar" />
      </fileset>
   </path>

   <path id="shared.dependency.classpath">
      <fileset dir="${genesis.dist}"
               includes="genesis-shared-${genesis.version}.jar" />
      <fileset dir="${hibernate.dist}" includes="hibernate*.jar" />
      <fileset dir="${commons.dist}" includes="commons-beanutils*.jar" />
      <fileset dir="${commons.dist}" includes="commons-logging*.jar" />
      <fileset dir="${commons.dist}" includes="reusable-components*.jar" />
   </path>

   <path id="client.dependency.classpath">
      <path location="${module.shared}/${build.dest}" />
      <fileset dir="${genesis.dist}"
               includes="genesis-shared-${genesis.version}.jar" />
      <fileset dir="${genesis.dist}"
               includes="genesis-client-${genesis.version}.jar" />
      <fileset dir="${commons.dist}" includes="commons-beanutils*.jar" />
      <fileset dir="${commons.dist}" includes="commons-jxpath*.jar" />
      <fileset dir="${commons.dist}" includes="commons-logging*.jar" />
      <fileset dir="${commons.dist}" includes="commons-validator*.jar" />
      <fileset dir="${commons.dist}" includes="reusable-components*.jar" />
      <fileset dir="${thinlet.dist}" includes="**/*.jar" />
   </path>

   <path id="run.classpath">
      <fileset dir="${build.dir}" includes="useradmin-weaved.jar" />
      <fileset dir="${build.dir}/${lib.dir}" includes="*.jar" />
      <fileset dir="${hibernate.dist}" includes="commons-collection*.jar" />
      <fileset dir="${genesis.dist}"
               includes="genesis-aspect-annotated-${genesis.version}.jar" />
      <fileset dir="${genesis.dist}"
               includes="genesis-client-${genesis.version}.jar" />
      <path refid="j2ee.path" />
      <path refid="client.dependency.classpath" />
      <path refid="shared.dependency.classpath" />
      <path refid="aspectwerkz.path" />
   </path>

   <target name="shared:clean">
      <delete dir="${module.shared}/${build.dir}" />
   </target>

   <target name="shared:compile">
      <mkdir dir="${module.shared}/${build.dest}" />
      <javac destdir="${module.shared}/${build.dest}"
             debug="true"
             source="1.4"
             classpathref="shared.dependency.classpath">
         <src path="${module.shared}/${src.dir}" />
      </javac>
      <copy todir="${module.shared}/${build.dest}" overwrite="false">
         <fileset dir="${module.shared}/${src.dir}" excludes="**/*.java" />
      </copy>
      <antcall target="shared:hibernatedoclet" />
      <antcall target="shared:annotation" />
   </target>

   <target name="shared:annotation">
      <mkdir dir="${module.shared}/${annotation.dest}" />
      <java classname="org.codehaus.aspectwerkz.annotation.AnnotationC"
            fork="true"
            failonerror="true">
         <arg value="-verbose" />
         <arg value="-src" />
         <arg value="${module.shared}/${src.dir}" />
         <arg value="-classes" />
         <arg value="${module.shared}/${build.dest}" />
         <arg value="-dest" />
         <arg value="${module.shared}/${annotation.dest}" />
         <arg value="-custom" />
         <arg value="${annotation.properties}" />
         <classpath>
            <path refid="aspectwerkz.path" />
         </classpath>
      </java>
      <copy todir="${module.shared}/${annotation.dest}" overwrite="false">
         <fileset dir="${module.shared}/${build.dest}" />
      </copy>
   </target>

   <target name="shared:hibernatedoclet">
      <mkdir dir="${module.shared}/${build.src}" />
      <taskdef name="hibernatedoclet"
               classname="xdoclet.modules.hibernate.HibernateDocletTask">
         <classpath refid="xdoclet.path" />
      </taskdef>
      <hibernatedoclet destdir="${module.shared}/${build.src}" verbose="true">
         <fileset dir="${module.shared}/${src.dir}">
            <include name="**/*.java" />
         </fileset>
         <hibernate version="2.0"
                    xmlencoding="ISO-8859-1"
                    validateXML="false" />
         <jbossservice jndiName="jboss:/hibernate/SessionFactory"
                       serviceName="HibernateFactory,name=HibernateFactory"
                       dialect="net.sf.hibernate.dialect.HSQLDialect"
                       dataSource="java:/DefaultDS"
                       transactionManagerStrategy="net.sf.hibernate.transaction.JBossTransactionManagerLookup"
                       transactionStrategy="net.sf.hibernate.transaction.JTATransactionFactory"
                       userTransactionName="UserTransaction"
                       useouterjoin="false"
                       showSql="true"
                       depends="jboss.jca:service=LocalTxCM,name=DefaultDS" />
         <hibernatecfg dialect="net.sf.hibernate.dialect.HSQLDialect"
                       userName="sa"
                       password=""
                       driver="org.hsqldb.jdbcDriver"
                       jdbcUrl="jdbc:hsqldb:."
                       transactionManagerStrategy="net.sf.hibernate.transaction.JDBCTransactionFactory"
                       showSql="true" />
      </hibernatedoclet>
      <copy todir="${module.shared}/${build.dest}">
         <fileset dir="${module.shared}/${build.src}" />
      </copy>
   </target>

   <target name="client:clean">
      <delete dir="${module.client}/${build.dir}" />
   </target>

   <target name="client:compile">
      <mkdir dir="${module.client}/${build.dest}" />
      <javac destdir="${module.client}/${build.dest}"
             debug="true"
             source="1.4"
             classpathref="client.dependency.classpath">
         <src path="${module.client}/${src.dir}" />
      </javac>
      <copy todir="${module.client}/${build.dest}" overwrite="false">
         <fileset dir="${module.client}/${src.dir}" excludes="**/*.java" />
      </copy>
      <antcall target="client:annotation" />
   </target>

   <target name="client:annotation">
      <mkdir dir="${module.client}/${annotation.dest}" />
      <java classname="org.codehaus.aspectwerkz.annotation.AnnotationC"
            fork="true"
            failonerror="true">
         <arg value="-verbose" />
         <arg value="-src" />
         <arg value="${module.client}/${src.dir}" />
         <arg value="-classes" />
         <arg value="${module.client}/${build.dest}" />
         <arg value="-dest" />
         <arg value="${module.client}/${annotation.dest}" />
         <arg value="-custom" />
         <arg value="${annotation.properties}" />
         <classpath>
            <path refid="aspectwerkz.path" />
         </classpath>
      </java>
      <copy todir="${module.client}/${annotation.dest}" overwrite="false">
         <fileset dir="${module.client}/${build.dest}" />
      </copy>
   </target>

   <target name="useradmin:weaving">
      <mkdir dir="${weaving.dest}" />
      <mkdir dir="${build.dir}/${lib.dir}" />
      <path id="weaving.path">
         <path refid="client.dependency.classpath" />
         <path refid="shared.dependency.classpath" />
      </path>
      <pathconvert pathsep="${path.separator}"
                   property="normalized.path"
                   refid="weaving.path" />
      <copy todir="${weaving.dest}" overwrite="true">
         <fileset dir="${module.client}/${annotation.dest}" />
         <fileset dir="${module.shared}/${annotation.dest}" />
      </copy>
      <copy todir="${build.dir}/${lib.dir}" overwrite="true">
         <fileset dir="${thinlet.dist}" includes="thinlet*.jar" />
         <fileset dir="${genesis.dist}"
                  includes="genesis-shared-annotated-${genesis.version}.jar" />
      </copy>
      <java classname="org.codehaus.aspectwerkz.compiler.AspectWerkzC"
            fork="true"
            failonerror="true">
         <arg value="-cp" />
         <arg value="${normalized.path}" />
         <arg value="-verbose" />
         <arg value="-haltOnError" />
         <arg value="${weaving.dest}" />
         <arg value="${build.dir}/${lib.dir}" />
         <jvmarg value="-Daspectwerkz.transform.verbose=true" />
         <classpath>
            <path refid="shared.dependency.classpath" />
            <path refid="client.dependency.classpath" />
            <path refid="aspectwerkz.path" />
            <path refid="j2ee.path" />
            <fileset file="${genesis.dist}/genesis-aspect-annotated-${genesis.version}.jar" />
         </classpath>
      </java>
   </target>

   <target name="useradmin:clean" depends="shared:clean,client:clean">
      <delete dir="${build.dir}" />
   </target>

   <target name="useradmin:compile"
           depends="useradmin:clean,shared:compile,client:compile,useradmin:weaving">
   </target>

   <target name="useradmin:jar">
      <mkdir dir="${build.dir}" />
      <jar destfile="${build.dir}/useradmin-weaved.jar">
         <fileset dir="${weaving.dest}" />
      </jar>
      <jar destfile="${build.dir}/useradmin-shared.jar">
         <fileset dir="${module.shared}/${build.dest}"
                  excludes="jboss-service.xml" />
      </jar>
   </target>

   <target name="useradmin:deploy">
      <mkdir dir="${jboss.app}/deploy/hibernate.sar" />
      <mkdir dir="${jboss.app}/deploy/useradmin.jar" />
      <copy todir="${jboss.app}/deploy/hibernate.sar">
         <fileset dir="${module.shared}/${build.src}">
            <include name="**/*.hbm.xml" />
         </fileset>
         <fileset dir="${module.shared}/${build.dest}">
            <include name="**/databeans/**/*.class" />
            <include name="hibernate.properties" />
         </fileset>
      </copy>
      <copy todir="${jboss.app}/deploy/hibernate.sar/META-INF">
         <fileset dir="${module.shared}/${build.src}"
                  includes="jboss-service.xml" />
      </copy>
      <copy todir="${jboss.app}/lib">
         <fileset dir="${hibernate.dist}">
            <include name="commons-logging*.jar" />
            <include name="log4j*.jar" />
            <include name="dom4j*.jar" />
            <include name="optional*.jar" />
            <include name="commons-collections*.jar" />
            <include name="ehcache*.jar" />
            <include name="cglib*.jar" />
            <include name="odmg*.jar" />
            <include name="hibernate*.jar" />
         </fileset>
         <fileset dir="${commons.dist}">
            <include name="commons-beanutils*.jar" />
            <include name="reusable-components*.jar" />
         </fileset>
         <fileset dir="${genesis.dist}">
            <include name="genesis-shared-${genesis.version}.jar" />
         </fileset>
      </copy>
      <copy todir="${jboss.app}/deploy/">
         <fileset dir="${genesis.dist}">
            <include name="genesis-server-${genesis.version}.jar" />
         </fileset>
      </copy>
      <unjar dest="${jboss.app}/deploy/useradmin.jar"
             src="${build.dir}/useradmin-shared.jar">
      </unjar>
   </target>

   <target name="useradmin:all"
           depends="useradmin:compile,useradmin:jar,useradmin:deploy" />

   <target name="useradmin:run">
      <java classname="example.Sample" fork="true" failonerror="true">
         <sysproperty key="java.naming.factory.initial"
                      value="org.jnp.interfaces.NamingContextFactory" />
         <sysproperty key="java.naming.provider.url"
                      value="${jboss.provider.url}" />
         <jvmarg value="-Daspectwerkz.transform.verbose=true" />
         <classpath>
            <path refid="run.classpath" />
            <pathelement path="${jboss.home}/client/jbossall-client.jar" />
         </classpath>
      </java>
   </target>

</project>